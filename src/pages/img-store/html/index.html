<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        .img-box {
            width: 100%;
        }

        .img-box div {
            display: inline-block;
            position: relative;
            width: 16%;
            margin: 2%;
            height: 100px;
            text-align: center;
        }

        .img-box .img-content {
            height: 60px;
            width: 100%;
            text-align: center;
        }

        .img-box span {
            color: #0398e5;
            font-size: 13px;
        }

        .upimg {
            height: 80px;
            text-align: center;
        }

        .upimg img {
            height: 80px;
            text-align: center;
        }

        .img-content {
            height: 60px;
            text-align: center;
        }

        .img-del {
            position: absolute;
            right: 0px;
            height: 20px;
            width: 20px;
            top: 0px;
        }

        .update,
        .upload-img {

            text-align: center;
            width: 161px;
            margin: 19px auto;
            background: #0398e5;
            height: 30px;
            line-height: 30px;
            color: white;
            border-radius: 8px;
        }

        
    </style>
</head>

<body>
    <input type="file" id="imgFiles" multiple style="display:none">
    <div class="upimg" for="imgFiles">
        <img src="./img/upimg.png" alt="">
    </div>
    <div class="upload-img">
        <label for="imgFiles">上传图片</label>
    </div>

    <div class="img-box"></div>
    <div id="save" class="update">提交</div>

</body>
<script src="./jq.js"></script>
<script>
    var base = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGYAAABmCAYAAAA53+RiAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjYxNUM4NTlDRTUyMzExRTdCOEEyRUIwRDQyM0FGNjFCIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjYxNUM4NTlERTUyMzExRTdCOEEyRUIwRDQyM0FGNjFCIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NjE1Qzg1OUFFNTIzMTFFN0I4QTJFQjBENDIzQUY2MUIiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NjE1Qzg1OUJFNTIzMTFFN0I4QTJFQjBENDIzQUY2MUIiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz71WQILAAAK5ElEQVR42uxd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';
    var filesDom = $('#imgFiles')[0],
        $imgBox = $('.img-box'),
        $save = $('#save');
    $(function () {
        var params = {
            StoreId: 1,
            getUrl: 'http://101.200.196.202:8888/Store/GetStoreImgs',
            upUrl: 'http://101.200.196.202:8888/Store/SaveStoreImg',
            deledeUrl: ''
        };

        var upImg = function (base) {
            $.ajax({
                url: params.upUrl,
                type: 'post',
                data: { StoreId: params.StoreId, ImgJson: JSON.stringify([{ ImgBase64: base, ImgNo: params.StoreId + '-' + Date.now() }]) },
                success: function (res) {
                    if (res.code > 0) {
                        resolve();
                    } else {
                        reject();
                    }
                },
                error: function (e) {
                    reject();
                }
            })
        };
        var getImg = function () {
            return new Promise(function (resolve, reject) {
                $.ajax({
                    url: params.getUrl,
                    type: 'post',
                    data: { StoreId: params.StoreId },
                    success: function (res) {
                        if (res.code > 0) {
                            resolve(res.data);
                        } else {
                            reject();
                        }
                    },
                    error: function (e) {
                        reject();
                    }
                })
            })
        };

        var prevImg = [];
        getImg(function (res) {
            console.log(res)
            prevImg = res.data.map(function (item) {
                return {
                    ImgUrl: item.ImgUrl,
                    Id: item.Id,
                    status: 'success'
                }
            });
            handleImgStatusChange();

        }, function (e) {
            console.log('获取图库数据失败', e)
        });
        var handleImgStatusChange = function () {
            //在这里 更改页面
            $imgBox.html();
            preUpImgs.forEach(function(item){
                console.log(item)
            });
            // for (var item in imgBase64) {
            //     var status = imgBase64[item].status;
            //     var label = '';
            //     switch (status) {
            //         case 'none':
            //             label = '未上传'
            //             break;
            //         case 'uping':
            //             label = '上传中...'
            //             break;
            //         case 'success':
            //             label = '上传成功'
            //             break;
            //         case 'error':
            //             label = '上传失败'
            //             break;
            //     }
            //     $('#' + item + '-img').siblings('p').text(label)
            // }
        }
       $imgBox.on('click', '.img-del', function () {
            var delIndex = $('.img-del').index(this);
            preUpImgs.splice(delIndex, 1);
            $imgBox.children().eq(delIndex).remove();
            toggleSubmitButtonVisible();
        });
        //监听文件改变
        $('#imgFiles').on('change', function () {
            //将FileList对象转为数组遍历
            var files = ([]).slice.call(filesDom.files);
            files
                //过滤图片之外的文件
                .filter(function (item) {
                    return item.type.indexOf('image') > -1
                })
                .forEach(function (file, i) {
                    (function (file, i) {
                        var reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = function (e) {
                            prevImg.push(
                                {
                                    ImgUrl: e.target.result,
                                    Id: '',
                                    status: 'none'
                                }
                            )
                        };
                    })(file, i);
                })

        });
        //ajax提交
        $save.on('click', function () {
            var preUpQueue = prevImg.map(function (item, i) {
                return Object.assign({}, item, { prevImgIndex: i })
            })
            var i = 0;
            preUpQueue.filter(function (item) {
                if (item.status === 'none' || item.status === 'error') {
                    return true
                } else {
                    return false
                }
            });



            var queuq = function (preUpQueue, i, isFirst) {

                if (preUpQueue[i]) {

                    prevImg[preUpQueue[i].prevImgIndex].status = 'uping';
                    handleImgStatusChange();

                    up(preUpQueue[i++])
                        .then(function () {
                            prevImg[preUpQueue[i - 1].prevImgIndex].status = 'success';
                            handleImgStatusChange();
                            queuq(preUpQueue, i);
                        }, function () {
                            prevImg[preUpQueue[i - 1].prevImgIndex].status = = 'error';
                            handleImgStatusChange();
                            queuq(preUpQueue, i);
                        })

                } else {
                    if (isFirst) {
                        alert('无可上传的图片')
                    }

                }
            }
            queuq(preUpQueue, i, true);




        })
    });
</script>

</html>